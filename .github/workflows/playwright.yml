name: Playwright Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
      options: --user 1001
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      # Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install dependencies
      - name: Install dependencies
        run: npm ci

      # TypeScript type check
      - name: Type check
        run: npm run check:types

      # Run all Playwright tests
      - name: Run Playwright Tests
        run: |
          npx playwright test \
            --project ${{ matrix.browser }} \
            --timeout=30000 \
            --retries=1

      # Upload test report as an artifact
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{matrix.browser}}
          path: reports/playwright-report
      - run: ls -la reports/playwright-report || echo "Folder not found"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Download Chromium report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-chromium
          path: site/chromium

      - name: Download Firefox report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-firefox
          path: site/firefox

      - name: Download Webkit report
        uses: actions/download-artifact@v4
        with:
          name: playwright-report-webkit
          path: site/webkit

      - name: Create index.html
        run: |
          cat <<EOF > site/index.html
          <!DOCTYPE html>
          <html>
          <head>
            <title>Playwright Test Reports</title>
            <style>
              body { font-family: Arial; text-align: center; padding: 40px; }
              h1 { margin-bottom: 30px; }
              a {
                display: inline-block;
                margin: 15px;
                padding: 15px 25px;
                font-size: 18px;
                text-decoration: none;
                background: #24292f;
                color: white;
                border-radius: 6px;
              }
              a:hover { background: #444; }
            </style>
          </head>
          <body>
            <h1>Playwright Test Reports</h1>
            <a href="./chromium/index.html">Chromium Report</a>
            <a href="./firefox/index.html">Firefox Report</a>
            <a href="./webkit/index.html">WebKit Report</a>
          </body>
          </html>
          EOF
      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4

  